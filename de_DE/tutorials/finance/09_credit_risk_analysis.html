

<!DOCTYPE html>
<html class="writer-html5" lang="de-DE" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Credit Risk Analysis &mdash; Qiskit 0.20.0 Dokumentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme-override.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/jupyter-sphinx.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0-alpha.0/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Stichwortverzeichnis" href="../../genindex.html" />
    <link rel="search" title="Suche" href="../../search.html" />
    <link rel="next" title="Option Pricing with qGANs" href="10_qgan_option_pricing.html" />
    <link rel="prev" title="Pricing Fixed-Income Assets" href="08_fixed_income_pricing.html" />
    <script>
    (function () {
      'use strict'
      window._analytics = {
        segment_key: 'ffdYLviQze3kzomaINXNk6NwpY9LlXcw',
        coremetrics: false,
        optimizely: false,
        googleAddServices: false,
        fullStory: false,
        autoPageEventSpa: false,
        autoFormEvents: false,
        autoPageView: false
      }

      window.digitalData = {
        page: {
          pageInfo: {
            productTitle: 'IBM Q Experience',
            analytics: {
              category: 'Qiskit.org'
            }
          }
        }
      }

      window._analyticsReady = window._analyticsReady || new Promise((resolve) => {
        const script = document.createElement('script')
        script.async = true
        script.src = 'https://cloud.ibm.com/analytics/build/bluemix-analytics.min.js'
        document.head.appendChild(script)
        script.onload = resolve
        script.onerror = (err) => {
          console.warn('Error loading Bluemix Analytics script:', err)
          resolve()
        }
      })

      window._analyticsReady.then(() => {
        if (!window.bluemixAnalytics || !window.digitalData) { return }

        const category = window.digitalData.page.pageInfo.analytics.category
        const productTitle = window.digitalData.page.pageInfo.productTitle
        const routeName = 'api-documentation'

        window.bluemixAnalytics.pageEvent(category, routeName, {
          navigationType: 'pushState',
          productTitle: productTitle,
          title: document.title
        })
      })
    }());
    </script>
     

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #212121" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Qiskit
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Qiskit installieren</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Einführung in Qiskit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../the_elements.html">Die Qiskit Elemente</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development_strategy.html">Development Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing_to_qiskit.html">An Qiskit mitwirken</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Häufig gestellte Fragen</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../circuits/index.html">Circuits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../circuits_advanced/index.html">Advanced Circuits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pulse/index.html">Pulse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulators/index.html">High-Performance Simulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../noise/index.html">Quantum System Error Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/index.html">Optimization</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Finance</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_portfolio_optimization.html"><strong>Portfolio Optimization</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="02_portfolio_diversification.html"><strong>Portfolio Diversification</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="03_european_call_option_pricing.html"><strong>Pricing European Call Options</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="04_european_put_option_pricing.html"><strong>Pricing European Put Options</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="05_bull_spread_pricing.html"><strong>Pricing Bull Spreads</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="06_basket_option_pricing.html"><strong>Pricing Basket Options</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="07_asian_barrier_spread_pricing.html"><strong>Pricing Asian Barrier Spreads</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="08_fixed_income_pricing.html"><strong>Pricing Fixed-Income Assets</strong></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#"><strong>Credit Risk Analysis</strong></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Problem-Definition">Problem Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Uncertainty-Model">Uncertainty Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Expected-Loss">Expected Loss</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Cumulative-Distribution-Function">Cumulative Distribution Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Value-at-Risk">Value at Risk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Conditional-Value-at-Risk">Conditional Value at Risk</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="10_qgan_option_pricing.html"><strong>Option Pricing with qGANs</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="11_time_series.html"><strong>Loading and Processing Stock-Market Time-Series Data</strong></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chemistry/index.html">Chemistry</a></li>
</ul>
<p class="caption"><span class="caption-text">Libraries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/circuit_library.html">Circuit Library</a></li>
</ul>
<p class="caption"><span class="caption-text">API-Referenzen</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/terra.html">Qiskit Terra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/aer.html">Qiskit Aer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/ignis.html">Qiskit Ignis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/aqua.html">Qiskit Aqua</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidoc/ibmq-provider.html">Qiskit IBM Quantum Provider</a></li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://quantum-computing.ibm.com/docs/cloud/errors">Quantum Experience API error codes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Qiskit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Finance Tutorials</a> &raquo;</li>
        
      <li><strong>Credit Risk Analysis</strong></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/tutorials/finance/09_credit_risk_analysis.ipynb" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition note">
<p class="admonition-title">Bemerkung</p>
<p>This page was generated from <a class="reference external" href="https://github.com/Qiskit/qiskit-tutorials/blob/master/tutorials/finance/09_credit_risk_analysis.ipynb">tutorials/finance/09_credit_risk_analysis.ipynb</a>.</p>
</div>
<div class="section" id="Credit-Risk-Analysis">
<h1><strong>Credit Risk Analysis</strong><a class="headerlink" href="#Credit-Risk-Analysis" title="Link zu dieser Überschrift">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Link zu dieser Überschrift">¶</a></h2>
<p>This tutorial shows how quantum algorithms can be used for credit risk analysis. More precisely, how Quantum Amplitude Estimation (QAE) can be used to estimate risk measures with a quadratic speed-up over classical Monte Carlo simulation. The tutorial is based on the following papers: - Quantum Risk Analysis. Stefan Woerner, Daniel J. Egger. [Woerner2019] - Credit Risk Analysis using Quantum Computers. Egger et al. (2019) [Egger2019]</p>
<p>A general introduction to QAE can be found in the following paper and tutorial: - Quantum Amplitude Amplification and Estimation. Gilles Brassard et al. - Qiskit Tutorial on Quantum Amplitude Estimation</p>
<p>The structure of the tutorial is as follows: 1. <a class="reference external" href="#Problem-Definition">Problem Definition</a> 2. <a class="reference external" href="#Uncertainty-Model">Uncertainty Model</a> 3. <a class="reference external" href="#Expected-Loss">Expected Loss</a> 4. <a class="reference external" href="#Cumulative-Distribution-Function">Cumulative Distribution Function</a> 5. <a class="reference external" href="#Value-at-Risk">Value at Risk</a> 6. <a class="reference external" href="#Conditional-Value-at-Risk">Conditional Value at Risk</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumRegister</span><span class="p">,</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">Aer</span><span class="p">,</span> <span class="n">execute</span>

<span class="kn">from</span> <span class="nn">qiskit.aqua.components.uncertainty_models</span> <span class="kn">import</span> <span class="n">GaussianConditionalIndependenceModel</span> <span class="k">as</span> <span class="n">GCI</span>
<span class="kn">from</span> <span class="nn">qiskit.aqua.components.uncertainty_problems</span> <span class="kn">import</span> <span class="n">UnivariatePiecewiseLinearObjective</span> <span class="k">as</span> <span class="n">PwlObjective</span>
<span class="kn">from</span> <span class="nn">qiskit.aqua.components.uncertainty_problems</span> <span class="kn">import</span> <span class="n">MultivariateProblem</span>
<span class="kn">from</span> <span class="nn">qiskit.aqua.circuits</span> <span class="kn">import</span> <span class="n">WeightedSumOperator</span>
<span class="kn">from</span> <span class="nn">qiskit.aqua.circuits</span>  <span class="kn">import</span> <span class="n">FixedValueComparator</span> <span class="k">as</span> <span class="n">Comparator</span>
<span class="kn">from</span> <span class="nn">qiskit.aqua.algorithms</span> <span class="kn">import</span> <span class="n">IterativeAmplitudeEstimation</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Problem-Definition">
<h2>Problem Definition<a class="headerlink" href="#Problem-Definition" title="Link zu dieser Überschrift">¶</a></h2>
<p>In this tutorial we want to analyze the credit risk of a portfolio of <span class="math notranslate nohighlight">\(K\)</span> assets. The default probability of every asset <span class="math notranslate nohighlight">\(k\)</span> follows a <em>Gaussian Conditional Independence</em> model, i.e., given a value <span class="math notranslate nohighlight">\(z\)</span> sampled from a latent random variable <span class="math notranslate nohighlight">\(Z\)</span> following a standard normal distribution, the default probability of asset <span class="math notranslate nohighlight">\(k\)</span> is given by</p>
<div class="math notranslate nohighlight">
\[p_k(z) = F\left( \frac{F^{-1}(p_k^0) - \sqrt{\rho_k}z}{\sqrt{1 - \rho_k}} \right)\]</div>
<p>where <span class="math notranslate nohighlight">\(F\)</span> denotes the cumulative distribution function of <span class="math notranslate nohighlight">\(Z\)</span>, <span class="math notranslate nohighlight">\(p_k^0\)</span> is the default probability of asset <span class="math notranslate nohighlight">\(k\)</span> for <span class="math notranslate nohighlight">\(z=0\)</span> and <span class="math notranslate nohighlight">\(\rho_k\)</span> is the sensitivity of the default probability of asset <span class="math notranslate nohighlight">\(k\)</span> with respect to <span class="math notranslate nohighlight">\(Z\)</span>. Thus, given a concrete realization of <span class="math notranslate nohighlight">\(Z\)</span> the individual default events are assumed to be independent from each other.</p>
<p>We are interested in analyzing risk measures of the total loss</p>
<div class="math notranslate nohighlight">
\[L = \sum_{k=1}^K \lambda_k X_k(Z)\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda_k\)</span> denotes the <em>loss given default</em> of asset <span class="math notranslate nohighlight">\(k\)</span>, and given <span class="math notranslate nohighlight">\(Z\)</span>, <span class="math notranslate nohighlight">\(X_k(Z)\)</span> denotes a Bernoulli variable representing the default event of asset <span class="math notranslate nohighlight">\(k\)</span>. More precisely, we are interested in the expected value <span class="math notranslate nohighlight">\(\mathbb{E}[L]\)</span>, the Value at Risk (VaR) of <span class="math notranslate nohighlight">\(L\)</span> and the Conditional Value at Risk of <span class="math notranslate nohighlight">\(L\)</span> (also called Expected Shortfall). Where VaR and CVaR are defined as</p>
<div class="math notranslate nohighlight">
\[\text{VaR}_{\alpha}(L) = \inf \{ x \mid \mathbb{P}[L &lt;= x] \geq 1 - \alpha \}\]</div>
<p>with confidence level <span class="math notranslate nohighlight">\(\alpha \in [0, 1]\)</span>, and</p>
<div class="math notranslate nohighlight">
\[\text{CVaR}_{\alpha}(L) = \mathbb{E}[ L \mid L \geq \text{VaR}_{\alpha}(L) ].\]</div>
<p>For more details on the considered model, see, e.g., Regulatory Capital Modeling for Credit Risk. Marek Rutkowski, Silvio Tarca</p>
<p>The problem is defined by the following parameters: - number of qubits used to represent <span class="math notranslate nohighlight">\(Z\)</span>, denoted by <span class="math notranslate nohighlight">\(n_z\)</span> - truncation value for <span class="math notranslate nohighlight">\(Z\)</span>, denoted by <span class="math notranslate nohighlight">\(z_{\text{max}}\)</span>, i.e., Z is assumed to take <span class="math notranslate nohighlight">\(2^{n_z}\)</span> equidistant values in <span class="math notranslate nohighlight">\(\{-z_{max}, ..., +z_{max}\}\)</span> - the base default probabilities for each asset <span class="math notranslate nohighlight">\(p_0^k \in (0, 1)\)</span>, <span class="math notranslate nohighlight">\(k=1, ..., K\)</span> - sensitivities of the default probabilities with respect to <span class="math notranslate nohighlight">\(Z\)</span>, denoted by <span class="math notranslate nohighlight">\(\rho_k \in [0, 1)\)</span> -
loss given default for asset <span class="math notranslate nohighlight">\(k\)</span>, denoted by <span class="math notranslate nohighlight">\(\lambda_k\)</span> - confidence level for VaR / CVaR <span class="math notranslate nohighlight">\(\alpha \in [0, 1]\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set problem parameters</span>
<span class="n">n_z</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">z_max</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">z_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">z_max</span><span class="p">,</span> <span class="n">z_max</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">n_z</span><span class="p">)</span>
<span class="n">p_zeros</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>
<span class="n">rhos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
<span class="n">lgd</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_zeros</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Uncertainty-Model">
<h2>Uncertainty Model<a class="headerlink" href="#Uncertainty-Model" title="Link zu dieser Überschrift">¶</a></h2>
<p>We now construct a circuit that loads the uncertainty model. This can be achieved by creating a quantum state in a register of <span class="math notranslate nohighlight">\(n_z\)</span> qubits that represents <span class="math notranslate nohighlight">\(Z\)</span> following a standard normal distribution. This state is then used to control single qubit Y-rotations on a second qubit register of <span class="math notranslate nohighlight">\(K\)</span> qubits, where a <span class="math notranslate nohighlight">\(|1\rangle\)</span> state of qubit <span class="math notranslate nohighlight">\(k\)</span> represents the default event of asset <span class="math notranslate nohighlight">\(k\)</span>. The resulting quantum state can be written as</p>
<div class="math notranslate nohighlight">
\[ |\Psi\rangle = \sum_{i=0}^{2^{n_z}-1} \sqrt{p_z^i} |z_i \rangle \bigotimes_{k=1}^K
\left( \sqrt{1 - p_k(z_i)}|0\rangle + \sqrt{p_k(z_i)}|1\rangle\right),\]</div>
<p>where we denote by <span class="math notranslate nohighlight">\(z_i\)</span> the <span class="math notranslate nohighlight">\(i\)</span>-th value of the discretized and truncated <span class="math notranslate nohighlight">\(Z\)</span> [Egger2019].</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># construct circuit factory for uncertainty model (Gaussian Conditional Independence model)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">GCI</span><span class="p">(</span><span class="n">n_z</span><span class="p">,</span> <span class="n">z_max</span><span class="p">,</span> <span class="n">p_zeros</span><span class="p">,</span> <span class="n">rhos</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># determine the number of qubits required to represent the uncertainty model</span>
<span class="n">num_qubits</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">num_target_qubits</span>

<span class="c1"># initialize quantum register and circuit</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="c1"># construct circuit</span>
<span class="n">u</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We now use the simulator to validate the circuit that constructs <span class="math notranslate nohighlight">\(|\Psi\rangle\)</span> and compute the corresponding exact values for - expected loss <span class="math notranslate nohighlight">\(\mathbb{E}[L]\)</span> - PDF and CDF of <span class="math notranslate nohighlight">\(L\)</span> - value at risk <span class="math notranslate nohighlight">\(VaR(L)\)</span> and corresponding probability - conditional value at risk <span class="math notranslate nohighlight">\(CVaR(L)\)</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># run the circuit and analyze the results</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;statevector_simulator&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># analyze uncertainty circuit and determine exact solutions</span>
<span class="n">p_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">n_z</span><span class="p">)</span>
<span class="n">p_default</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_statevector</span><span class="p">()):</span>

    <span class="c1"># get binary representation</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;{0:0</span><span class="si">%s</span><span class="s1">b}&#39;</span> <span class="o">%</span> <span class="n">num_qubits</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># extract value of Z and corresponding probability</span>
    <span class="n">i_normal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="o">-</span><span class="n">n_z</span><span class="p">:],</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">p_z</span><span class="p">[</span><span class="n">i_normal</span><span class="p">]</span> <span class="o">+=</span> <span class="n">prob</span>

    <span class="c1"># determine overall default probability for k</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">K</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">p_default</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">prob</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">lgd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">+=</span> <span class="p">[</span><span class="n">loss</span><span class="p">]</span>
    <span class="n">probabilities</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prob</span><span class="p">]</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

<span class="n">expected_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">)</span>

<span class="n">losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">):</span>
    <span class="n">pdf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="n">values</span> <span class="o">==</span> <span class="n">v</span><span class="p">])</span>
<span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>

<span class="n">i_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">cdf</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
<span class="n">exact_var</span> <span class="o">=</span> <span class="n">losses</span><span class="p">[</span><span class="n">i_var</span><span class="p">]</span>
<span class="n">exact_cvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pdf</span><span class="p">[(</span><span class="n">i_var</span><span class="o">+</span><span class="mi">1</span><span class="p">):],</span> <span class="n">losses</span><span class="p">[(</span><span class="n">i_var</span><span class="o">+</span><span class="mi">1</span><span class="p">):])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">pdf</span><span class="p">[(</span><span class="n">i_var</span><span class="o">+</span><span class="mi">1</span><span class="p">):])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected Loss E[L]:                </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">expected_loss</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Value at Risk VaR[L]:              </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exact_var</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P[L &lt;= VaR[L]]:                    </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cdf</span><span class="p">[</span><span class="n">exact_var</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Conditional Value at Risk CVaR[L]: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exact_cvar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Expected Loss E[L]:                0.6409
Value at Risk VaR[L]:              2.0000
P[L &lt;= VaR[L]]:                    0.9591
Conditional Value at Risk CVaR[L]: 3.0000
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># plot loss PDF, expected loss, var, and cvar</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">pdf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">expected_loss</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;E[L]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">exact_var</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VaR(L)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">exact_cvar</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;CVaR(L)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Loss L ($)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Loss Distribution&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_finance_09_credit_risk_analysis_12_0.png" src="../../_images/tutorials_finance_09_credit_risk_analysis_12_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># plot results for Z</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_values</span><span class="p">,</span> <span class="n">p_z</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Z value&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Z Distribution&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_finance_09_credit_risk_analysis_13_0.png" src="../../_images/tutorials_finance_09_credit_risk_analysis_13_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># plot results for default probabilities</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">p_default</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Asset&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability (%)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Individual Default Probabilities&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_finance_09_credit_risk_analysis_14_0.png" src="../../_images/tutorials_finance_09_credit_risk_analysis_14_0.png" />
</div>
</div>
</div>
<div class="section" id="Expected-Loss">
<h2>Expected Loss<a class="headerlink" href="#Expected-Loss" title="Link zu dieser Überschrift">¶</a></h2>
<p>To estimate the expected loss, we first apply a weighted sum operator to sum up individual losses to total loss:</p>
<div class="math notranslate nohighlight">
\[\mathcal{S}: |x_1, ..., x_K \rangle_K |0\rangle_{n_S} \mapsto |x_1, ..., x_K \rangle_K |\lambda_1x_1 + ... + \lambda_K x_K\rangle_{n_S}.\]</div>
<p>The required number of qubits to represent the result is given by</p>
<div class="math notranslate nohighlight">
\[n_s = \lfloor \log_2( \lambda_1 + ... + \lambda_K ) \rfloor + 1.\]</div>
<p>Once we have the total loss distribution in a quantum register, we can use the techniques described in [Woerner2019] to map a total loss <span class="math notranslate nohighlight">\(L \in \{0, ..., 2^{n_s}-1\}\)</span> to the amplitude of an objective qubit by an operator</p>
<div class="math notranslate nohighlight">
\[ | L \rangle_{n_s}|0\rangle \mapsto
| L \rangle_{n_s} \left( \sqrt{1 - L/(2^{n_s}-1)}|0\rangle + \sqrt{L/(2^{n_s}-1)}|1\rangle \right),\]</div>
<p>which allows to run amplitude estimation to evaluate the expected loss.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># determine number of qubits required to represent total loss</span>
<span class="n">n_s</span> <span class="o">=</span> <span class="n">WeightedSumOperator</span><span class="o">.</span><span class="n">get_required_sum_qubits</span><span class="p">(</span><span class="n">lgd</span><span class="p">)</span>

<span class="c1"># create circuit factory (add Z qubits with weight/loss 0)</span>
<span class="n">agg</span> <span class="o">=</span> <span class="n">WeightedSumOperator</span><span class="p">(</span><span class="n">n_z</span> <span class="o">+</span> <span class="n">K</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n_z</span> <span class="o">+</span> <span class="n">lgd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define linear objective function</span>
<span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">slopes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">f_min</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lgd</span><span class="p">)</span>
<span class="n">c_approx</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="n">objective</span> <span class="o">=</span> <span class="n">PwlObjective</span><span class="p">(</span>
    <span class="n">agg</span><span class="o">.</span><span class="n">num_sum_qubits</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">2</span><span class="o">**</span><span class="n">agg</span><span class="o">.</span><span class="n">num_sum_qubits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># max value that can be reached by the qubit register (will not always be reached)</span>
    <span class="n">breakpoints</span><span class="p">,</span>
    <span class="n">slopes</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">,</span>
    <span class="n">f_min</span><span class="p">,</span>
    <span class="n">f_max</span><span class="p">,</span>
    <span class="n">c_approx</span>
<span class="p">)</span>

<span class="c1"># define overall multivariate problem</span>
<span class="n">multivariate</span> <span class="o">=</span> <span class="n">MultivariateProblem</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">objective</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Before we use QAE to estimate the expected loss, we validate the quantum circuit representing the objective function by just simulating it directly and analyzing the probability of the objective qubit being in the <span class="math notranslate nohighlight">\(|1\rangle\)</span> state, i.e., the value QAE will eventually approximate.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">num_qubits</span> <span class="o">=</span> <span class="n">multivariate</span><span class="o">.</span><span class="n">num_target_qubits</span>
<span class="n">num_ancillas</span> <span class="o">=</span> <span class="n">multivariate</span><span class="o">.</span><span class="n">required_ancillas</span><span class="p">()</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">q_a</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_ancillas</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_a&#39;</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_a</span><span class="p">)</span>

<span class="n">multivariate</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<pre style="word-wrap: normal;white-space: pre;background: #fff0;line-height: 1.1;font-family: &quot;Courier New&quot;,Courier,monospace">                                ┌───┐┌────────────────┐┌───┐┌──────────────┐»
  q_0: ─────────────────────────┤ X ├┤ U3(0.7907,0,0) ├┤ X ├┤ U3(pi/2,0,0) ├»
       ┌──────────────┐┌───────┐└─┬─┘└────────────────┘└─┬─┘└──────────────┘»
  q_1: ┤ U3(pi/2,0,0) ├┤ U1(0) ├──■──────────────────────■──────────────────»
       └──────────────┘└───────┘                                            »
  q_2: ─────────────────────────────────────────────────────────────────────»
                                                                            »
  q_3: ─────────────────────────────────────────────────────────────────────»
                                                                            »
  q_4: ─────────────────────────────────────────────────────────────────────»
                                                                            »
q_a_0: ─────────────────────────────────────────────────────────────────────»
                                                                            »
q_a_1: ─────────────────────────────────────────────────────────────────────»
                                                                            »
q_a_2: ─────────────────────────────────────────────────────────────────────»
                                                                            »
«       ┌───┐┌───────┐┌───┐┌───────┐┌─────────┐┌─────────┐ ░ ┌────────┐ ░ »
«  q_0: ┤ X ├┤ U1(0) ├┤ X ├┤ U1(0) ├┤0        ├┤0        ├─░─┤0       ├─░─»
«       └─┬─┘└───────┘└─┬─┘└───────┘│         ││         │ ░ │        │ ░ »
«  q_1: ──■─────────────■───────────┤1 LinRot ├┤1        ├─░─┤1       ├─░─»
«                                   │         ││  LinRot │ ░ │        │ ░ »
«  q_2: ────────────────────────────┤2        ├┤         ├─░─┤2       ├─░─»
«                                   └─────────┘│         │ ░ │        │ ░ »
«  q_3: ───────────────────────────────────────┤2        ├─░─┤3       ├─░─»
«                                              └─────────┘ ░ │  adder │ ░ »
«  q_4: ───────────────────────────────────────────────────░─┤        ├─░─»
«                                                          ░ │        │ ░ »
«q_a_0: ───────────────────────────────────────────────────░─┤4       ├─░─»
«                                                          ░ │        │ ░ »
«q_a_1: ───────────────────────────────────────────────────░─┤5       ├─░─»
«                                                          ░ │        │ ░ »
«q_a_2: ───────────────────────────────────────────────────░─┤6       ├─░─»
«                                                          ░ └────────┘ ░ »
«                   ░ ┌───────────┐ ░
«  q_0: ────────────░─┤0          ├─░─
«                   ░ │           │ ░
«  q_1: ────────────░─┤1          ├─░─
«                   ░ │           │ ░
«  q_2: ────────────░─┤2          ├─░─
«                   ░ │           │ ░
«  q_3: ────────────░─┤3          ├─░─
«       ┌─────────┐ ░ │  adder_dg │ ░
«  q_4: ┤2        ├─░─┤           ├─░─
«       │         │ ░ │           │ ░
«q_a_0: ┤0        ├─░─┤4          ├─░─
«       │  pw_lin │ ░ │           │ ░
«q_a_1: ┤1        ├─░─┤5          ├─░─
«       │         │ ░ │           │ ░
«q_a_2: ┤3        ├─░─┤6          ├─░─
«       └─────────┘ ░ └───────────┘ ░ </pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">job</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;statevector_simulator&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># evaluate resulting statevector</span>
<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_statevector</span><span class="p">()):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;{0:0</span><span class="si">%s</span><span class="s1">b}&#39;</span> <span class="o">%</span> <span class="n">multivariate</span><span class="o">.</span><span class="n">num_target_qubits</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="o">-</span><span class="n">multivariate</span><span class="o">.</span><span class="n">num_target_qubits</span><span class="p">:]</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">am</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">+=</span> <span class="n">am</span><span class="o">**</span><span class="mi">2</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact Expected Loss:   </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">expected_loss</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact Operator Value:  </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mapped Operator value: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">multivariate</span><span class="o">.</span><span class="n">value_to_estimation</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exact Expected Loss:   0.6409
Exact Operator Value:  0.3906
Mapped Operator value: 0.6640
</pre></div></div>
</div>
<p>Next we run QAE to estimate the expected loss with a quadratic speed-up over classical Monte Carlo simulation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set target precision and confidence level</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># construct amplitude estimation</span>
<span class="n">ae</span> <span class="o">=</span> <span class="n">IterativeAmplitudeEstimation</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">a_factory</span><span class="o">=</span><span class="n">multivariate</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">quantum_instance</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;qasm_simulator&#39;</span><span class="p">),</span> <span class="n">shots</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># print results</span>
<span class="n">conf_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;confidence_interval&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact value:    </span><span class="se">\t</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">expected_loss</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated value:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;estimation&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confidence interval: </span><span class="se">\t</span><span class="s1">[</span><span class="si">%.4f</span><span class="s1">, </span><span class="si">%.4f</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conf_int</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exact value:            0.6409
Estimated value:        0.6511
Confidence interval:    [0.6335, 0.6687]
</pre></div></div>
</div>
</div>
<div class="section" id="Cumulative-Distribution-Function">
<h2>Cumulative Distribution Function<a class="headerlink" href="#Cumulative-Distribution-Function" title="Link zu dieser Überschrift">¶</a></h2>
<p>Instead of the expected loss (which could also be estimated efficiently using classical techniques) we now estimate the cumulative distribution function (CDF) of the loss. Classically, this either involves evaluating all the possible combinations of defaulting assets, or many classical samples in a Monte Carlo simulation. Algorithms based on QAE have the potential to significantly speed up this analysis in the future.</p>
<p>To estimate the CDF, i.e., the probability $ <span class="math">\mathbb{P}`[L :nbsphinx-math:</span>leq <cite>x] $, we again apply :math:</cite>mathcal{S}` to compute the total loss, and then apply a comparator that for a given value <span class="math notranslate nohighlight">\(x\)</span> acts as</p>
<div class="math notranslate nohighlight">
\[\begin{split} \mathcal{C}: |L\rangle_n|0&gt; \mapsto
\begin{cases}
|L\rangle_n|1&gt; &amp; \text{if}\quad L \leq x \\
|L\rangle_n|0&gt; &amp; \text{if}\quad L &gt; x.
\end{cases}\end{split}\]</div>
<p>The resulting quantum state can be written as</p>
<div class="math notranslate nohighlight">
\[ \sum_{L = 0}^{x} \sqrt{p_{L}}|L\rangle_{n_s}|1\rangle +
\sum_{L = x+1}^{2^{n_s}-1} \sqrt{p_{L}}|L\rangle_{n_s}|1\rangle,\]</div>
<p>where we directly assume the summed up loss values and corresponding probabilities instead of presenting the details of the uncertainty model.</p>
<p>The CDF(<span class="math notranslate nohighlight">\(x\)</span>) equals the probability of measuring <span class="math notranslate nohighlight">\(|1\rangle\)</span> in the objective qubit and QAE can be directly used to estimate it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define value x to evaluate the CDF(x)</span>
<span class="k">def</span> <span class="nf">get_cdf_operator_factory</span><span class="p">(</span><span class="n">x_eval</span><span class="p">):</span>

    <span class="c1"># comparator as objective</span>
    <span class="n">cdf_objective</span> <span class="o">=</span> <span class="n">Comparator</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">num_sum_qubits</span><span class="p">,</span> <span class="n">x_eval</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">geq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># define overall uncertainty problem</span>
    <span class="n">multivariate_cdf</span> <span class="o">=</span> <span class="n">MultivariateProblem</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">cdf_objective</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">multivariate_cdf</span>
</pre></div>
</div>
</div>
<p>Again, we first use quantum simulation to validate the quantum circuit.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set x value to estimate the CDF</span>
<span class="n">x_eval</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># get operator</span>
<span class="n">multivariate_cdf</span> <span class="o">=</span> <span class="n">get_cdf_operator_factory</span><span class="p">(</span><span class="n">x_eval</span><span class="p">)</span>

<span class="c1"># get required number of qubits</span>
<span class="n">num_qubits</span> <span class="o">=</span> <span class="n">multivariate_cdf</span><span class="o">.</span><span class="n">num_target_qubits</span>
<span class="n">num_ancillas</span> <span class="o">=</span> <span class="n">multivariate_cdf</span><span class="o">.</span><span class="n">required_ancillas</span><span class="p">()</span>  <span class="c1"># TODO: why do we need two more ancillas?</span>

<span class="c1"># construct circuit</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">q_a</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_ancillas</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_a&#39;</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_a</span><span class="p">)</span>

<span class="n">multivariate_cdf</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Applications/anaconda3/lib/python3.7/site-packages/ipykernel_launcher.py:5: DeprecationWarning: The qiskit.aqua.circuits.FixedValueComparator object is deprecated and will be removed no earlier than 3 months after the 0.7.0 release of Qiskit Aqua. You should use qiskit.circuit.library.IntegerComparator instead.
  &#34;&#34;&#34;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">job</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;statevector_simulator&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">qc</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<pre style="word-wrap: normal;white-space: pre;background: #fff0;line-height: 1.1;font-family: &quot;Courier New&quot;,Courier,monospace">                                ┌───┐┌────────────────┐┌───┐┌──────────────┐»
  q_0: ─────────────────────────┤ X ├┤ U3(0.7907,0,0) ├┤ X ├┤ U3(pi/2,0,0) ├»
       ┌──────────────┐┌───────┐└─┬─┘└────────────────┘└─┬─┘└──────────────┘»
  q_1: ┤ U3(pi/2,0,0) ├┤ U1(0) ├──■──────────────────────■──────────────────»
       └──────────────┘└───────┘                                            »
  q_2: ─────────────────────────────────────────────────────────────────────»
                                                                            »
  q_3: ─────────────────────────────────────────────────────────────────────»
                                                                            »
  q_4: ─────────────────────────────────────────────────────────────────────»
                                                                            »
q_a_0: ─────────────────────────────────────────────────────────────────────»
                                                                            »
q_a_1: ─────────────────────────────────────────────────────────────────────»
                                                                            »
q_a_2: ─────────────────────────────────────────────────────────────────────»
                                                                            »
«       ┌───┐┌───────┐┌───┐┌───────┐┌─────────┐┌─────────┐ ░ ┌────────┐ ░ »
«  q_0: ┤ X ├┤ U1(0) ├┤ X ├┤ U1(0) ├┤0        ├┤0        ├─░─┤0       ├─░─»
«       └─┬─┘└───────┘└─┬─┘└───────┘│         ││         │ ░ │        │ ░ »
«  q_1: ──■─────────────■───────────┤1 LinRot ├┤1        ├─░─┤1       ├─░─»
«                                   │         ││  LinRot │ ░ │        │ ░ »
«  q_2: ────────────────────────────┤2        ├┤         ├─░─┤2       ├─░─»
«                                   └─────────┘│         │ ░ │        │ ░ »
«  q_3: ───────────────────────────────────────┤2        ├─░─┤3       ├─░─»
«                                              └─────────┘ ░ │  adder │ ░ »
«  q_4: ───────────────────────────────────────────────────░─┤        ├─░─»
«                                                          ░ │        │ ░ »
«q_a_0: ───────────────────────────────────────────────────░─┤4       ├─░─»
«                                                          ░ │        │ ░ »
«q_a_1: ───────────────────────────────────────────────────░─┤5       ├─░─»
«                                                          ░ │        │ ░ »
«q_a_2: ───────────────────────────────────────────────────░─┤6       ├─░─»
«                                                          ░ └────────┘ ░ »
«                ░ ┌───────────┐ ░
«  q_0: ─────────░─┤0          ├─░─
«                ░ │           │ ░
«  q_1: ─────────░─┤1          ├─░─
«                ░ │           │ ░
«  q_2: ─────────░─┤2          ├─░─
«                ░ │           │ ░
«  q_3: ─────────░─┤3          ├─░─
«       ┌──────┐ ░ │  adder_dg │ ░
«  q_4: ┤2     ├─░─┤           ├─░─
«       │      │ ░ │           │ ░
«q_a_0: ┤0     ├─░─┤4          ├─░─
«       │  cmp │ ░ │           │ ░
«q_a_1: ┤1     ├─░─┤5          ├─░─
«       │      │ ░ │           │ ░
«q_a_2: ┤3     ├─░─┤6          ├─░─
«       └──────┘ ░ └───────────┘ ░ </pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># evaluate resulting statevector</span>
<span class="n">var_prob</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_statevector</span><span class="p">()):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;{0:0</span><span class="si">%s</span><span class="s1">b}&#39;</span> <span class="o">%</span> <span class="n">multivariate_cdf</span><span class="o">.</span><span class="n">num_target_qubits</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="o">-</span><span class="n">multivariate_cdf</span><span class="o">.</span><span class="n">num_target_qubits</span><span class="p">:]</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="n">var_prob</span> <span class="o">+=</span> <span class="n">prob</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Operator CDF(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">x_eval</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact    CDF(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">x_eval</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cdf</span><span class="p">[</span><span class="n">x_eval</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Operator CDF(2) = 0.9591
Exact    CDF(2) = 0.9591
</pre></div></div>
</div>
<p>Next we run QAE to estimate the CDF for a given <span class="math notranslate nohighlight">\(x\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set target precision and confidence level</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># construct amplitude estimation</span>
<span class="n">ae_cdf</span> <span class="o">=</span> <span class="n">IterativeAmplitudeEstimation</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">a_factory</span><span class="o">=</span><span class="n">multivariate_cdf</span><span class="p">)</span>
<span class="n">result_cdf</span> <span class="o">=</span> <span class="n">ae_cdf</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">quantum_instance</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;qasm_simulator&#39;</span><span class="p">),</span> <span class="n">shots</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># print results</span>
<span class="n">conf_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_cdf</span><span class="p">[</span><span class="s1">&#39;confidence_interval&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact value:    </span><span class="se">\t</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cdf</span><span class="p">[</span><span class="n">x_eval</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated value:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result_cdf</span><span class="p">[</span><span class="s1">&#39;estimation&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confidence interval: </span><span class="se">\t</span><span class="s1">[</span><span class="si">%.4f</span><span class="s1">, </span><span class="si">%.4f</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conf_int</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exact value:            0.9591
Estimated value:        0.9587
Confidence interval:    [0.9578, 0.9596]
</pre></div></div>
</div>
</div>
<div class="section" id="Value-at-Risk">
<h2>Value at Risk<a class="headerlink" href="#Value-at-Risk" title="Link zu dieser Überschrift">¶</a></h2>
<p>In the following we use a bisection search and QAE to efficiently evaluate the CDF to estimate the value at risk.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">run_ae_for_cdf</span><span class="p">(</span><span class="n">x_eval</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">simulator</span><span class="o">=</span><span class="s1">&#39;qasm_simulator&#39;</span><span class="p">):</span>

    <span class="c1"># construct amplitude estimation</span>
    <span class="n">multivariate_var</span> <span class="o">=</span> <span class="n">get_cdf_operator_factory</span><span class="p">(</span><span class="n">x_eval</span><span class="p">)</span>
    <span class="n">ae_var</span> <span class="o">=</span> <span class="n">IterativeAmplitudeEstimation</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">a_factory</span><span class="o">=</span><span class="n">multivariate_var</span><span class="p">)</span>
    <span class="n">result_var</span> <span class="o">=</span> <span class="n">ae_var</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">quantum_instance</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="n">simulator</span><span class="p">),</span> <span class="n">shots</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result_var</span><span class="p">[</span><span class="s1">&#39;estimation&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">bisection_search</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">target_value</span><span class="p">,</span> <span class="n">low_level</span><span class="p">,</span> <span class="n">high_level</span><span class="p">,</span> <span class="n">low_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the smallest level such that the objective value is still larger than the target</span>
<span class="sd">    :param objective: objective function</span>
<span class="sd">    :param target: target value</span>
<span class="sd">    :param low_level: lowest level to be considered</span>
<span class="sd">    :param high_level: highest level to be considered</span>
<span class="sd">    :param low_value: value of lowest level (will be evaluated if set to None)</span>
<span class="sd">    :param high_value: value of highest level (will be evaluated if set to None)</span>
<span class="sd">    :return: dictionary with level, value, num_eval</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check whether low and high values are given and evaluated them otherwise</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start bisection search for target value </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">target_value</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">num_eval</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">low_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">low_value</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">low_level</span><span class="p">)</span>
        <span class="n">num_eval</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">high_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">high_value</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">high_level</span><span class="p">)</span>
        <span class="n">num_eval</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># check if low_value already satisfies the condition</span>
    <span class="k">if</span> <span class="n">low_value</span> <span class="o">&gt;</span> <span class="n">target_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">low_level</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">low_value</span><span class="p">,</span> <span class="s1">&#39;num_eval&#39;</span><span class="p">:</span> <span class="n">num_eval</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;returned low value&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">low_value</span> <span class="o">==</span> <span class="n">target_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">low_level</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">low_value</span><span class="p">,</span> <span class="s1">&#39;num_eval&#39;</span><span class="p">:</span> <span class="n">num_eval</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span>

    <span class="c1"># check if high_value is above target</span>
    <span class="k">if</span> <span class="n">high_value</span> <span class="o">&lt;</span> <span class="n">target_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">high_level</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">high_value</span><span class="p">,</span> <span class="s1">&#39;num_eval&#39;</span><span class="p">:</span> <span class="n">num_eval</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;returned low value&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">high_value</span> <span class="o">==</span> <span class="n">target_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">high_level</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">high_value</span><span class="p">,</span> <span class="s1">&#39;num_eval&#39;</span><span class="p">:</span> <span class="n">num_eval</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span>

    <span class="c1"># perform bisection search until</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;low_level    low_value    level    value    high_level    high_value&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">high_level</span> <span class="o">-</span> <span class="n">low_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

        <span class="n">level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">high_level</span> <span class="o">+</span> <span class="n">low_level</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">num_eval</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%2d</span><span class="s1">           </span><span class="si">%.3f</span><span class="s1">        </span><span class="si">%2d</span><span class="s1">       </span><span class="si">%.3f</span><span class="s1">    </span><span class="si">%2d</span><span class="s1">            </span><span class="si">%.3f</span><span class="s1">&#39;</span> \
              <span class="o">%</span> <span class="p">(</span><span class="n">low_level</span><span class="p">,</span> <span class="n">low_value</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">high_level</span><span class="p">,</span> <span class="n">high_value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">target_value</span><span class="p">:</span>
            <span class="n">high_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="n">high_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">low_level</span> <span class="o">=</span> <span class="n">level</span>
            <span class="n">low_value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># return high value after bisection search</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finished bisection search&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">high_level</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">high_value</span><span class="p">,</span> <span class="s1">&#39;num_eval&#39;</span><span class="p">:</span> <span class="n">num_eval</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># run bisection search to determine VaR</span>
<span class="n">objective</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">run_ae_for_cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">bisection_result</span> <span class="o">=</span> <span class="n">bisection_search</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span> <span class="n">low_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">bisection_result</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------------------------------
start bisection search for target value 0.950
--------------------------------------------------------------------
low_level    low_value    level    value    high_level    high_value
--------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Applications/anaconda3/lib/python3.7/site-packages/ipykernel_launcher.py:5: DeprecationWarning: The qiskit.aqua.circuits.FixedValueComparator object is deprecated and will be removed no earlier than 3 months after the 0.7.0 release of Qiskit Aqua. You should use qiskit.circuit.library.IntegerComparator instead.
  &#34;&#34;&#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-1           0.000         1       0.751     3            1.000
 1           0.751         2       0.958     3            1.000
--------------------------------------------------------------------
finished bisection search
--------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated Value at Risk: </span><span class="si">%2d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">var</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact Value at Risk:     </span><span class="si">%2d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exact_var</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated Probability:    </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bisection_result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact Probability:        </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cdf</span><span class="p">[</span><span class="n">exact_var</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimated Value at Risk:  2
Exact Value at Risk:      2
Estimated Probability:    0.958
Exact Probability:        0.959
</pre></div></div>
</div>
</div>
<div class="section" id="Conditional-Value-at-Risk">
<h2>Conditional Value at Risk<a class="headerlink" href="#Conditional-Value-at-Risk" title="Link zu dieser Überschrift">¶</a></h2>
<p>Last, we compute the CVaR, i.e. the expected value of the loss conditional to it being larger than or equal to the VaR. To do so, we evaluate a piecewise linear objective function <span class="math notranslate nohighlight">\(f(L)\)</span>, dependent on the total loss <span class="math notranslate nohighlight">\(L\)</span>, that is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split} f(L) = \begin{cases}
0 &amp; \text{if}\quad L \leq VaR \\
L &amp; \text{if}\quad L &gt; VaR.
\end{cases}\end{split}\]</div>
<p>To normalize, we have to divide the resulting expected value by the VaR-probability, i.e. <span class="math notranslate nohighlight">\(\mathbb{P}[L \leq VaR]\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># define linear objective</span>
<span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="p">]</span>
<span class="n">slopes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># subtract VaR and add it later to the estimate</span>
<span class="n">f_min</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">var</span>
<span class="n">c_approx</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="n">cvar_objective</span> <span class="o">=</span> <span class="n">PwlObjective</span><span class="p">(</span>
    <span class="n">agg</span><span class="o">.</span><span class="n">num_sum_qubits</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">2</span><span class="o">**</span><span class="n">agg</span><span class="o">.</span><span class="n">num_sum_qubits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># max value that can be reached by the qubit register (will not always be reached)</span>
    <span class="n">breakpoints</span><span class="p">,</span>
    <span class="n">slopes</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">,</span>
    <span class="n">f_min</span><span class="p">,</span>
    <span class="n">f_max</span><span class="p">,</span>
    <span class="n">c_approx</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">multivariate_cvar</span> <span class="o">=</span> <span class="n">MultivariateProblem</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">cvar_objective</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">num_qubits</span> <span class="o">=</span> <span class="n">multivariate_cvar</span><span class="o">.</span><span class="n">num_target_qubits</span>
<span class="n">num_ancillas</span> <span class="o">=</span> <span class="n">multivariate_cvar</span><span class="o">.</span><span class="n">required_ancillas</span><span class="p">()</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">q_a</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_ancillas</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_a&#39;</span><span class="p">)</span>
<span class="n">qc</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q_a</span><span class="p">)</span>

<span class="n">multivariate_cvar</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">q_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Again, we first use quantum simulation to validate the quantum circuit.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">job</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;statevector_simulator&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># evaluate resulting statevector</span>
<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">get_statevector</span><span class="p">()):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;{0:0</span><span class="si">%s</span><span class="s1">b}&#39;</span> <span class="o">%</span> <span class="n">multivariate_cvar</span><span class="o">.</span><span class="n">num_target_qubits</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="o">-</span><span class="n">multivariate_cvar</span><span class="o">.</span><span class="n">num_target_qubits</span><span class="p">:]</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">am</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">+=</span> <span class="n">am</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># normalize and add VaR to estimate</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">multivariate_cvar</span><span class="o">.</span><span class="n">value_to_estimation</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">bisection_result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">normalized_value</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">var</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated CVaR: </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">normalized_value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact CVaR:     </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exact_cvar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Estimated CVaR: 3.2567
Exact CVaR:     3.0000
</pre></div></div>
</div>
<p>Next we run QAE to estimate the CVaR.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set target precision and confidence level</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># construct amplitude estimation</span>
<span class="n">ae_cvar</span> <span class="o">=</span> <span class="n">IterativeAmplitudeEstimation</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">a_factory</span><span class="o">=</span><span class="n">multivariate_cvar</span><span class="p">)</span>
<span class="n">result_cvar</span> <span class="o">=</span> <span class="n">ae_cvar</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">quantum_instance</span><span class="o">=</span><span class="n">Aer</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(</span><span class="s1">&#39;qasm_simulator&#39;</span><span class="p">),</span> <span class="n">shots</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># print results</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">bisection_result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">result_cvar</span><span class="p">[</span><span class="s1">&#39;estimation&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exact CVaR:    </span><span class="se">\t</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exact_cvar</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimated CVaR:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="n">var</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exact CVaR:     3.0000
Estimated CVaR: 3.1470
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">qiskit.tools.jupyter</span>
<span class="o">%</span><span class="k">qiskit_version_table</span>
<span class="o">%</span><span class="k">qiskit_copyright</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<h3>Version Information</h3><table><tr><th>Qiskit Software</th><th>Version</th></tr><tr><td>Qiskit</td><td>0.19.1</td></tr><tr><td>Terra</td><td>0.14.1</td></tr><tr><td>Aer</td><td>0.5.1</td></tr><tr><td>Ignis</td><td>0.3.0</td></tr><tr><td>Aqua</td><td>0.7.0</td></tr><tr><td>IBM Q Provider</td><td>0.7.0</td></tr><tr><th>System information</th></tr><tr><td>Python</td><td>3.7.4 (default, Aug 13 2019, 15:17:50)
[Clang 4.0.1 (tags/RELEASE_401/final)]</td></tr><tr><td>OS</td><td>Darwin</td></tr><tr><td>CPUs</td><td>6</td></tr><tr><td>Memory (Gb)</td><td>16.0</td></tr><tr><td colspan='2'>Fri Jul 17 17:32:27 2020 CEST</td></tr></table></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div style='width: 100%; background-color:#d5d9e0;padding-left: 10px; padding-bottom: 10px; padding-right: 10px; padding-top: 5px'><h3>This code is a part of Qiskit</h3><p>&copy; Copyright IBM 2017, 2020.</p><p>This code is licensed under the Apache License, Version 2.0. You may<br>obtain a copy of this license in the LICENSE.txt file in the root directory<br> of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.<p>Any modifications or derivative works of this code must retain this<br>copyright notice, and modified files need to carry a notice indicating<br>that they have been altered from the originals.</p></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="10_qgan_option_pricing.html" class="btn btn-neutral float-right" title="Option Pricing with qGANs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="08_fixed_income_pricing.html" class="btn btn-neutral float-left" title="Pricing Fixed-Income Assets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Qiskit Development Team
      <span class="lastupdated">
        Zuletzt aktualisiert am 2020/08/18.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Zu sehen ist</span>
    lang: German
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>Sprachen</dt>
      
        <dd><a class="version" href="/documentation/tutorials/finance/09_credit_risk_analysis.html">English</a></dd>
      
        <dd><a class="version" href="/documentation/locale/ja_JP/tutorials/finance/09_credit_risk_analysis.html">Japanese</a></dd>
      
        <dd><a class="version" href="/documentation/locale/de_DE/tutorials/finance/09_credit_risk_analysis.html">German</a></dd>
      
        <dd><a class="version" href="/documentation/locale/ko_KR/tutorials/finance/09_credit_risk_analysis.html">Korean</a></dd>
      
    </dl>
    
  </div>
  <script>
    jQuery('.version').click((evt) => {
      const hash = window.location.hash
      const complete_url = evt.target.href + hash
      window.location = complete_url
      evt.preventDefault()
    })
  </script>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>